// =========================
// LOGIN E CADASTRO
// =========================

function mostrarCadastro() {
  document.getElementById("login").style.display = "none";
  document.getElementById("cadastro").style.display = "block";
}

function mostrarLogin() {
  document.getElementById("cadastro").style.display = "none";
  document.getElementById("login").style.display = "block";
}

function cadastrar() {
  const novoUser = document.getElementById("novoUsuario").value;
  const novaSenha = document.getElementById("novaSenha").value;

  if (novoUser && novaSenha) {
    localStorage.setItem("usuario", novoUser);
    localStorage.setItem("senha", novaSenha);
    alert("Usuário cadastrado com sucesso!");
    mostrarLogin();
  } else {
    alert("Preencha todos os campos!");
  }
}

function entrar() {
  const user = document.getElementById("usuario").value;
  const senha = document.getElementById("senha").value;
  const userSalvo = localStorage.getItem("usuario");
  const senhaSalva = localStorage.getItem("senha");

  if (user === userSalvo && senha === senhaSalva) {
    document.getElementById("login").style.display = "none";
    document.getElementById("conteudo").style.display = "block";
    carregarGaleria();
  } else {
    alert("Usuário ou senha incorretos!");
  }
}

function sair() {
  document.getElementById("conteudo").style.display = "none";
  document.getElementById("login").style.display = "block";
  document.getElementById("usuario").value = "";
  document.getElementById("senha").value = "";
}

// =========================
// CADASTRO DE PEÇAS
// =========================

document.getElementById('enviar').addEventListener('click', () => {
  const arquivoInput = document.getElementById('arquivo');
  const codigoInput = document.getElementById('codigo');
  const descricaoInput = document.getElementById('descricao');
  const galeria = document.getElementById('galeria');

  const arquivos = Array.from(arquivoInput.files);
  const codigo = codigoInput.value.trim();
  const descricao = descricaoInput.value.trim();

  if (!codigo) return alert('Digite o código da peça!');
  if (arquivos.length === 0) return alert('Escolha pelo menos uma foto ou vídeo!');

  const medias = [];
  let carregadas = 0;

  arquivos.forEach(arquivo => {
    const reader = new FileReader();
    reader.onload = e => {
      medias.push({
        url: e.target.result,
        type: arquivo.type.startsWith('image') ? 'image' : 'video'
      });
      carregadas++;

      if (carregadas === arquivos.length) {
        const card = criarCard(codigo, descricao, medias);
        galeria.appendChild(card);
        salvarNoLocalStorage(codigo, descricao, medias);
      }
    };
    reader.readAsDataURL(arquivo);
  });

  codigoInput.value = '';
  descricaoInput.value = '';
  arquivoInput.value = '';
});

// =========================
// FUNÇÕES DOS CARDS
// =========================

function criarCard(codigo, descricao, medias) {
  const container = document.createElement('div');
  container.className = 'card';

  // Imagem de capa
  const capa = document.createElement('img');
  capa.src = medias[0].url;
  container.appendChild(capa);

  // Código
  const label = document.createElement('div');
  label.className = 'label';
  label.textContent = codigo;
  container.appendChild(label);

  // Descrição
  const descricaoBox = document.createElement('div');
  descricaoBox.className = 'descricao';
  descricaoBox.textContent = descricao;
  container.appendChild(descricaoBox);

  // Botões
  const botoes = document.createElement('div');
  botoes.className = 'botoes';

  const btnEditar = document.createElement('button');
  btnEditar.textContent = 'Editar';
  btnEditar.onclick = () => editarCard(container, codigo, descricao);
  botoes.appendChild(btnEditar);

  const btnExcluir = document.createElement('button');
  btnExcluir.textContent = 'Excluir';
  btnExcluir.onclick = () => {
    container.remove();
    removerDoLocalStorage(codigo);
  };
  botoes.appendChild(btnExcluir);

  container.appendChild(botoes);

  return container;
}

function salvarNoLocalStorage(codigo, descricao, medias) {
  const pecas = JSON.parse(localStorage.getItem('pecas') || '[]');
  pecas.push({ codigo, descricao, medias });
  localStorage.setItem('pecas', JSON.stringify(pecas));
}

function removerDoLocalStorage(codigo) {
  const pecas = JSON.parse(localStorage.getItem('pecas') || '[]');
  const novas = pecas.filter(p => p.codigo !== codigo);
  localStorage.setItem('pecas', JSON.stringify(novas));
}

// =========================
// EDIÇÃO
// =========================

function editarCard(container, codigoAntigo, descricaoAntiga) {
  const novoCodigo = prompt("Editar código:", codigoAntigo);
  const novaDescricao = prompt("Editar descrição:", descricaoAntiga);

  if (!novoCodigo || !novaDescricao) return;

  // Atualiza na tela
  container.querySelector('.label').textContent = novoCodigo;
  container.querySelector('.descricao').textContent = novaDescricao;

  // Atualiza no localStorage
  const pecas = JSON.parse(localStorage.getItem('pecas') || '[]');
  const index = pecas.findIndex(p => p.codigo === codigoAntigo);

  if (index !== -1) {
    pecas[index].codigo = novoCodigo;
    pecas[index].descricao = novaDescricao;
    localStorage.setItem('pecas', JSON.stringify(pecas));
  }
}

// =========================
// CARREGAR GALERIA AO ENTRAR
// =========================

function carregarGaleria() {
  const galeria = document.getElementById('galeria');
  galeria.innerHTML = "";

  const pecas = JSON.parse(localStorage.getItem('pecas') || '[]');

  pecas.forEach(p => {
    const card = criarCard(p.codigo, p.descricao, p.medias);
    galeria.appendChild(card);
  });
}
